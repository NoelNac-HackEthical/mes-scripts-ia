#!/bin/bash

# Vérification de l'argument
if [ -z "$1" ]; then
    echo "❌ Usage: $0 <IP_OU_DOMAINE>"
    exit 1
fi

TARGET="$1"
OUTPUT_DIR="mes_scans"

# Création du répertoire de sortie
mkdir -p "$OUTPUT_DIR"

# ===== ÉTAPE 1: SCAN COMPLET DES PORTS TCP =====
echo "[1/4] Scan complet des ports TCP..."
nmap -Pn -p- --min-rate 5000 -T4 --max-retries 3 -oN "$OUTPUT_DIR/full_tcp_scan.txt" "$TARGET"

# ===== ÉTAPE 2: EXTRACTION DES PORTS OUVERTS =====
PORTS=$(grep -E '^[0-9]+/tcp.*open' "$OUTPUT_DIR/full_tcp_scan.txt" | awk '{print $1}' | cut -d'/' -f1 | tr '\n' ',' | sed 's/,$//')
echo "Ports ouverts: $PORTS"

# ===== ÉTAPE 3: SCAN AGRESSIF CIBLÉ (Filtré : score > 9.0 + *EXPLOIT*) =====
if [ -n "$PORTS" ]; then
    echo "[2/4] Scan agressif sur les ports $PORTS..."
    VULN_SCRIPTS="vuln,http-vuln-*,ssl-cert,ssl-enum-ciphers,http-sql-injection,http-shellshock"

    # 1. Lancer le scan complet dans un fichier temporaire
    TEMP_FILE="$OUTPUT_DIR/aggressive_vuln_scan_full.txt"
    nmap -Pn -A -sV -p"$PORTS" --script="$VULN_SCRIPTS" --script-timeout=30s -T4 -oN "$TEMP_FILE" "$TARGET"

    # 2. Filtrer les vulnérabilités > 9.0 ET marquées *EXPLOIT*
    echo -e "[+] Vulnérabilités exploitables critiques (> 9.0) pour $TARGET\n" > "$OUTPUT_DIR/aggressive_vuln_scan.txt"

    # Variables pour gérer le contexte
    keep_context=0
    current_score=0

    # Parcourir le fichier temporaire ligne par ligne
    while IFS= read -r line; do
        # Vérifier si la ligne contient un score CVSS
        if [[ $line =~ [[:space:]]+([0-9]+\.[0-9])[[:space:]]+ ]]; then
            current_score=${BASH_REMATCH[1]}

            # Vérifier si la ligne contient *EXPLOIT*
            if [[ $line =~ \*EXPLOIT\* ]]; then
                if (( $(echo "$current_score > 9.0" | bc -l) )); then
                    keep_context=1  # Garder cette vulnérabilité et son contexte
                else
                    keep_context=0  # Ignorer cette vulnérabilité
                fi
            else
                keep_context=0  # Pas d'exploit disponible
            fi
        fi

        # Si on doit garder la ligne (soit contexte, soit ligne normale)
        if [[ $keep_context -eq 1 ]] || [[ ! $line =~ [[:space:]]+[0-9]+\.[0-9][[:space:]]+ ]]; then
            # Éviter les doublons (lignes vides)
            if [[ ! $line =~ ^[[:space:]]*$ ]]; then
                echo "$line" >> "$OUTPUT_DIR/aggressive_vuln_scan.txt"
            fi
        fi
    done < "$TEMP_FILE"

    # Vérifier si le fichier est vide
    if [ ! -s "$OUTPUT_DIR/aggressive_vuln_scan.txt" ]; then
        echo "[!] Aucune vulnérabilité exploitable critique (> 9.0) trouvée." > "$OUTPUT_DIR/aggressive_vuln_scan.txt"
    fi

    # Nettoyer le fichier temporaire
    rm -f "$TEMP_FILE"
else
    echo "⚠️ Aucun port TCP ouvert détecté. Scan agressif ignoré."
fi

# ===== ÉTAPE 4: SCAN CIBLÉ CMS =====
if [ -n "$PORTS" ]; then
    echo "[3/4] Scan orienté CMS sur les ports $PORTS..."
    CMS_SCRIPTS="http-wordpress-enum,http-wordpress-brute,http-wordpress-users,http-drupal-enum,http-drupal-enum-users,http-joomla-brute,http-generator,http-robots.txt,http-title,http-headers,http-methods,http-enum,http-devframework,http-cakephp-version,http-php-version,http-config-backup,http-backup-finder,http-sitemap-generator"
    nmap -Pn -sV -p"$PORTS" --script="$CMS_SCRIPTS" --script-timeout=30s -T4 -oN "$OUTPUT_DIR/cms_vuln_scan.txt" "$TARGET"
fi

# ===== ÉTAPE 5: SCAN UDP CIBLÉ =====
echo "[4/4] Scan UDP (top 20 ports)..."
nmap -n -Pn -sU --top-ports 20 -T4 -oN "$OUTPUT_DIR/udp_vuln_scan.txt" "$TARGET"

echo "✅ Scans terminés. Résultats filtrés (score > 9.0 + *EXPLOIT*) dans $OUTPUT_DIR/aggressive_vuln_scan.txt"
